<form version="1.1" script="explorer.js" stylesheet="analytics.css,common.css">
    <label>Data Explorer</label>
    <description>This view describes the flags and alerts seen within the environment, along with details of high-risk sources.</description>

    <fieldset autoRun="true" submitButton="false">
        <input type="time" searchWhenChanged="true">
            <label>Time range:</label>
            <default>Last 24 hours</default>
        </input>

        <input type="dropdown" token="groupfilter" searchWhenChanged="true">
            <label>Group:</label>
            <prefix>groups="</prefix>
            <suffix>"</suffix>
            <default>*</default>
            <choice value="*">All</choice>
            <fieldForLabel>src_groups</fieldForLabel>
            <fieldForValue>src_groups</fieldForValue>
            <search id="groupfiltersearch">
                <earliest>$earliest$</earliest>
                <latest>$latest$</latest>
                <query>
                    `nbaeventsindex` type=alert | stats count by src_groups
                </query>
            </search>
        </input>

        <input type="dropdown" token="riskscore" searchWhenChanged="true">
            <label>Minimum risk:</label>
            <default>1</default>
            <choice value="1">Informational</choice>
            <choice value="2">Low</choice>
            <choice value="3">Medium</choice>
            <choice value="4">High</choice>
            <choice value="5">Critical</choice>
        </input>

        <input type="dropdown" token="sectionfilter" searchWhenChanged="true">
            <label>Event source:</label>
            <prefix>section="</prefix>
            <suffix>"</suffix>
            <default>All sources</default>
            <choice value="*">All sources</choice>
            <choice value="dns">DNS analytics</choice>
            <choice value="ip">IP analytics</choice>
            <choice value="http">HTTP analytics</choice>
            <choice value="tls">TLS analytics</choice>
        </input>

        <input type="dropdown" token="actionfilter" searchWhenChanged="true">
            <label>Event action:</label>
            <default>Show all events</default>
            <choice value="all">Show all events</choice>
            <choice value="notblocked">Suppress blocked events</choice>
        </input>

        <input type="multiselect" token="threatexclude" searchWhenChanged="true" id="threatexcluder">
            <label>Excluded threats:</label>
            <choice value=" ">[show all]</choice>
            <default> </default>
            <prefix>(</prefix>
            <suffix>)</suffix>
            <valuePrefix>threats != "</valuePrefix>
            <valueSuffix>"</valueSuffix>
            <delimiter> AND </delimiter>
            <fieldForLabel>threats</fieldForLabel>
            <fieldForValue>threats</fieldForValue>
            <search>
                <earliest>$earliest$</earliest>
                <latest>$latest$</latest>
                <query>`nbaeventsindex` type=alert | stats count by threats</query>
            </search>
        </input>
    </fieldset>

    <search id="basesearch">
        <query>
            `nbaeventsindex` type=alert $threatexclude$ $sectionfilter$
            | eval action_filter_matched=`match_filter_event_action("$actionfilter$")`
            | search action_filter_matched=1
            | lookup asocnbathreats name AS threats OUTPUT title, severity
            | eval max_severity = max(severity)
            | search max_severity >= $riskscore$
            | eval threats=if(isnull(threats), "-", mvjoin(mvsort(threats), ", "))
            | eval groups=if(isnull(src_groups), "-", src_groups)
            | search $groupfilter$
            | eval groups=mvjoin(mvsort(groups), ", ")
            | eval alert_source = if(isnull(src_disp) or src_disp == "", src_ip, src_disp)
            | fields _time, original_event, alert_source, dest, dest_port, dest_host, dest_ip,
            section, severity, groups, threats, details.*
        </query>
    </search>

    <row>
        <panel>
            <title>Suspicious destinations</title>
            <table id="suspiciousdestinations">
                <search base="basesearch"><query>
                    fields alert_source, dest, severity
                    | stats sparkline AS Trend, c(alert_source) AS "Count", dc(alert_source) AS "Sources", max(severity) AS "Risk" by dest
                    | sort -"Risk", -"Count"
                    | rename dest AS "Destination"
                </query></search>
                <format type="sparkline" field="Trend">
                    <option name="lineColor">#5379af</option>
                    <option name="lineWidth">1</option>
                    <option name="height">17</option>
                </format>
                <option name="drilldown">row</option>
                <drilldown>
                    <set token="dest">$row.Destination$</set>
                    <link><![CDATA[
                        /app/network_behavior_analytics/search?earliest=$earliest$&latest=$latest$&q=search%20`nbaeventsindex`%20type=alert%20dest=$dest$
                    ]]></link>
                </drilldown>
            </table>
        </panel>
        <panel>
            <title>High risk sources</title>
            <table id="highrisksourcestable">
                <search base="basesearch"><query>
                    fields alert_source, severity
                    | stats sparkline AS "Trend", count AS "Count", max(severity) as "Risk" by alert_source,
                    | sort -"Risk", -"Count"
                    | rename alert_source AS "Source"
                </query></search>
                <format type="sparkline" field="Trend">
                    <option name="lineColor">#5379af</option>
                    <option name="lineWidth">1</option>
                    <option name="height">17</option>
                </format>
                <option name="drilldown">row</option>
                <drilldown>
                    <set token="alert_source">$row.Source$</set>
                    <link><![CDATA[
                        /app/network_behavior_analytics/search?earliest=$earliest$&latest=$latest$&q=search%20`nbaeventsindex`%20type=alert%20src_disp=$alert_source$
                    ]]></link>
                </drilldown>
            </table>
        </panel>
    </row>
    <row>
        <panel>
            <title>Threat breakdown</title>
            <chart>
                <search base="basesearch"><query>
                    makemv delim=", " threats
                    | stats count by threats
                    | search threats != "-"
                    | sort -count
                </query></search>
                <option name="charting.chart">bar</option>
                <option name="charting.legend.placement">none</option>
                <option name="charting.axisTitleY.text">Number of events</option>
                <option name="charting.axisTitleX.text">Threat</option>
                <option name="charting.axisLabelsX.majorLabelVisibility">hide</option>
                <drilldown>
                    <set token="threat">$click.value$</set>
                    <link><![CDATA[
                        /app/network_behavior_analytics/search?earliest=$earliest$&latest=$latest$&q=search%20`nbaeventsindex`%20type=alert%20threats=$threat$
                    ]]></link>
                </drilldown>
            </chart>
        </panel>
        <panel>
            <title>Alerts over time</title>
            <chart>
                <search base="basesearch"><query>
                    eval max_severity = max(severity)
                    | timechart count by max_severity
                    | rename count as "Alerts", 0 as "0: None", 1 as "1: Informational",
                      2 as "2: Low", 3 as "3: Medium", 4 as "4: High", 5 as "5: Critical"
                </query></search>
                <option name="charting.chart.stackMode">stacked</option>
                <option name="charting.axisTitleX.text">Selected time range</option>
                <option name="charting.drilldown">none</option>
            </chart>
        </panel>
    </row>
    <row>
        <panel>
            <title>Individual alerts</title>
            <table id="rawalerts">
                <search base="basesearch"><query>
                    eval c_time=strftime(strptime(original_event, "%d-%b-%Y %H:%M:%S%z"), "%d-%b-%Y %H:%M:%S")
                    | eval fdest=`format_dest(section, dest, dest_port)`
                    | eval dest=if(isnull(fdest) or fdest == "", dest, fdest)
                    | eval dest=if(isnull(dest), "-", dest)
                    | eval max_severity = max(severity)
                    | sort -c_time
                    | table c_time, alert_source, groups, dest, threats, max_severity
                    | rename c_time as "Time", alert_source as "Source", groups as "Group", dest as "Destination", max_severity as "Risk", threats as "Threats"
                </query></search>
                <option name="drilldown">row</option>
                <drilldown>
                    <set token="alert_source">$row.Source$</set>
                    <set token="dest">$row.Destination$</set>
                    <link><![CDATA[
                        /app/network_behavior_analytics/search?earliest=$earliest$&latest=$latest$&q=search%20`nbaeventsindex`%20type=alert%20src_disp=$alert_source$%20|%20eval%20fdest=`format_dest(section,%20dest,%20dest_port)`%20|%20eval%20dest=if(isnull(fdest)%20or%20fdest%20==%20"",%20dest,%20fdest)%20|%20search%20dest=$dest$
                    ]]></link>
                </drilldown>
            </table>
        </panel>
    </row>
    <row>
        <panel>
            <title>Destination locations</title>
            <map>
                <search base="basesearch"><query>
                    eval dest = if(isnotnull(dest_host), dest_host, if(isnotnull(dest_ip), dest_ip, ""))
                    | top dest by section limit=5
                    | lookup dnslookup clienthost AS dest
                    | iplocation clientip
                    | fields dest lat lon count
                    | rename dest as Destination, count as Count
                    | geostats sum(Count) by Destination
                </query></search>
                <option name="height">400</option>
                <option name="mapping.seriesColors">[0x5379af,0x9ac23c,0xf7902b,0x956d95,0x6ab7c7,0xd85d3c,0xfac51c,0xdd86af]</option>
                <option name="mapping.markerLayer.markerOpacity">0.8</option>
                <option name="mapping.markerLayer.markerMinSize">30</option>
                <option name="mapping.markerLayer.markerMaxSize">60</option>
            </map>
        </panel>
    </row>
</form>
